<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>localplayer</title>
  <style>
    body,
    body * {
      margin: 0;         
      padding: 0;
      border: 0;
      outline: 0;
      box-sizing: border-box;
    }

    body {
      width: 100vw;
      height: 100vh;
      max-width: 100%;
    }
   
    .topping {
      background-color: lightgreen;
      height: 15vh;
      width: 100%;
;

      display: flex;
      flex-direction: row; 
      justify-content: center;
      align-items: center;
    }

    .topping >*{
      border: 1px dashed darkslategray;
    }

    #fileinput_container {
      display: flex;
      justify-content: center;
      align-items: center;
      width:50%;
      height: 100%;
      position: relative;
   }

   #fileinput {
      width:100%;
      height: 100%;
      z-index:100;
      opacity: 0;
      position: absolute;
    }

    #tracks {
      width: 100%;
      max-height: 60vh;
      overflow-x: scroll;
      background-color: lightcyan;
    }

    #tracks>li {
      width: 100%;
      height: 10vh;
      display: flex;
      justify-content: start;
    }

    audio{
      width: 100%;
    }

    .app{
      width: 100vw;
      height: 100vh;
      background: sandybrown;
      position: relative;
    }

    .app >* {
      width: 100%;
      display: flex;
    }

    ::root{ --footer-height: 15vh; }
    .footer{
      width:100%;
      height: var(--footer-height);
      position: absolute;
      bottom:0;
      flex-direction: row;
      justify-content: space-between;
      align-items: stretch;
    }

    .player_tab_toggler{}
    .playlist_tab_toggler{}


    ::root{ --tabs-height: calc(100vh - var(--footer-height)); }
    .tabs{
      position: absolute;
      top: 0;
      width:100%;
      height: var(--tabs-height);
    }
 
    .main .playlist .player {
      height: 100%;
      width: 100%;
    }

    ::root{ --header-height: 15%; }
    .header{
      height: var(--header-height);
      background: lightgreen;
    }

    ::root{ --feed-height: 85%; }
    .feed{
      height: var(--feed-height);;

      flex-direction: column;
      overflow-x: scroll;
      background-color: lightcyan;
    }

    .feed .section{
      width: 100%;
    }

    .playlist{   
    }
    .player{
    }

    .hidden{
      visibility: hidden;
    }

    .visible {
      visibility: visible;
    }

    

  </style>
</head>

<body>
  <div class="app">
 
  <nav class="footer">
    <div class="playlist_tab_toggler"></div>
    <div class="player_tab_toggler"></div>
  </nav><!-- footer end -->

  <div class="tabs">
    <main class="main visible">
      <header class="header"></header><!-- header end -->
      <div class="feed"></div><!-- feed end -->
    </main><!-- main end -->
    <div class="playlist">
      <ul id="tracks"> </ul><!-- tracks end -->
      <div class="controls"></div><!--controls end-->
      <div class="add_file">
        <div id="fileinput_container">
          <input type="file" multiple  accept="audio/*, video/*" id="fileinput" name="fileinput" />
          <label for="fileinput" id="fileinput_label">Add local track</label>
        </div>
        <div id="urlinput_container">
          <input type="url" id="urlinput" name="urlinput">
          <label for="urlinput">audio <span>not</span> exists</label>
          <button>Add remote url track</button>
        </div>
      </div><!-- add_file end -->
    </div><!-- playlist end -->
  
    <div class="player">
    </div><!-- player end-->
  </div><!-- tabs end -->
  
  </div><!-- app end -->

  <script defer>

  class Player{

    constructor(){
      let dom_audio = document.createElement("audio");
      dom_audio.controls = "controls";
      document.querySelector(".player").appendChild(dom_audio);
    }

  }


  let dom_tracks_list = document.querySelector("#tracks");
  let audio_array = [];
  audio_array.i = 0;

  audio_array.next = function (otarget = this) {
    if (otarget.length < 1) { otarget.i = -1; throw  new Error("storage length less or equal 0"); };
    
    ++otarget.i;
    if (otarget.i >= otarget.length) { otarget.i = 0; };
      
    return otarget[otarget.i];
  };


  
  function dom_audio_onplayend(el) {
    //debugger;
    el.target.src = audio_hooks_list.next().url;
    el.target.play();
    return true;
  };
  dom_audio.addEventListener("ended", dom_audio_onplayend);
  
  let audio_hooks_list = new Proxy(audio_array, {
    "set": function (otarget, skey, vvalue) {

     //if key is not a number, set anyway
     if (isNaN(+skey)) { otarget[skey] = vvalue; return true; };

     //if key is number, check object properties
     if (!vvalue.url || !vvalue.name) { return false; };

     otarget.push(vvalue);

     let li = document.createElement("li");
     li.innerText = vvalue.name;
     dom_tracks_list.appendChild(li);

     if (dom_audio.src == "") { dom_audio.src = vvalue.url };
       return true;
     };
   });

  const mime_type_validator = ((player, file) => {
      let can = player.canPlayType(file.type); // "" => false, ie cant
      if(!can){ 
        throw new Error("file extension defenitely cant be played");
      };
      //file extension can be unplayable, but file is playable
  }).bind(audio);

  const push_files_to_list = files => {
    for (let i = 0, l = files.length; i < l; ++i) {
      let file = files[i];

      try{mime_type_validator(file)}catch(err){console.error(err);};

      audio_hooks_list.push({ url: URL.createObjectURL(file), name: file.name });
    };
  };

  let fileinput = document.querySelector("#fileinput");
  fileinput.addEventListener("change",e=>{
    push_files_to_list(fileinput.files);
  });

  window.addEventListener("dragover", e => e.preventDefault(), false); 
  window.addEventListener("drop", event => {
    event.preventDefault();
    push_files_to_list(event.dataTransfer.files);
  });

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register("/localplayer/serviceworker.js", { scope: "/localplayer/" })
    .then(_ => console.log("sw ok"))
    .catch(_ => console.log(`sw not ok : ${_}`));
  } else {
     console.log("no sw ");
  };


    </script>

</body>

</html>
