
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>localplayer</title>
  <style>
     body, body * {
      margin: 0;         
      padding: 0;
      border: 0;
      outline: 0;
      box-sizing: border-box;
    
      border: 1px dashed darkslategray;
    }
    :root{
      --footer-height: 15vh;
      --tabs-height: calc(100vh - var(--footer-height)); 

      --header-height: 15%; 
      --feed-height: 85%; 
    }

    body {
      width: 100vw;
      height: 100vh;
      max-width: 100%;
    }
   
    .add_file {
      
      height: 15vh;
      width: 100%;


      display: flex;
      flex-direction: row; 
      justify-content: space-between;
      align-items: stretch;
    }

    

    #fileinput_container {
      display: flex;
      justify-content: center;
      align-items: center;
      width:50%;
      height: 100%;
      position: relative;
   }

   #fileinput {
      width:100%;
      height: 100%;
      z-index:50;
      opacity: 0;
      position: absolute;
    }

    .tracks {
      width: 100%;
      overflow-x: scroll;
      
    }

    .tracks>li {
      width: 100%;
      height: 10vh;
      display: flex;
      justify-content: start;
    }

    audio{
      width: 100%;
    }

    .app{
      width: 100vw;
      height: 100vh;
      background: sandybrown;
      position: relative;
    }

    
    .footer{
      width:100%;
      height: var(--footer-height);
      position: absolute;
      bottom:0;

      display:flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: stretch;
      background: pink;
    }

    .player_tab_toggler{
       width:50%;
     }
    .playlist_tab_toggler{
       width:50%;
     }

    .player_tab_toggler.active ,
    .playlist_tab_toggler.active {
      background: purple;
    }
    
    .tabs{
      position: absolute;
      top: 0;
      width:100%;
      height: var(--tabs-height);
    }
 

    .main{
      background: darkblue;
    }
    .playlist{
      background: darkgreen;
    }
    .player{
      background: gold; 
    }

    .main, .playlist, .player {
      position: absolute;

      height: 100%;
      width: 100%;
    }

    
    .header{
      height: var(--header-height);
      
    }

   
    .feed{
      height: var(--feed-height);;

      flex-direction: column;
      overflow-x: scroll;
    }

    .feed .section{
      width: 100%;
    }

    .playlist{   
    }
    .player{
    }

    .hidden{
      visibility: hidden;
      z-index: 0;
    }

    .visible {
      visibility: visible;
      z-index: 100;
    }

    

  </style>
</head>

<body>
  <div class="app">
 
  <nav class="footer">
    <div class="playlist_tab_toggler">playlist</div>
    <div class="player_tab_toggler">player</div>
  </nav><!-- footer end -->

  <div class="tabs">
    <main class="main visible">
      <header class="header">head</header><!-- header end -->
      <div class="feed">feed</div><!-- feed end -->
    </main><!-- main end -->
    <div class="playlist hidden">
      <ul class="tracks">tracks</ul><!-- tracks end -->
      <div class="controls">controls</div><!--controls end-->
      <div class="add_file">
        <div id="fileinput_container">
          <input type="file" multiple  accept="audio/*, video/*" id="fileinput" name="fileinput" />
          <label for="fileinput" id="fileinput_label">Add local track</label>
        </div>
        <div id="urlinput_container">
          <input type="url" id="urlinput" name="urlinput">
          <label for="urlinput">audio <span>not</span> exists</label>
          <button>Add remote url track</button>
        </div>
      </div><!-- add_file end -->
    </div><!-- playlist end -->
  
    <div class="player hidden">
    </div><!-- player end-->
  </div><!-- tabs end -->
  
  </div><!-- app end -->

  <script defer>


  class Player_worker{

    #dom_player;
    #onplayend;


    constructor(){
      this.#dom_player = document.createElement("audio");
      this.#dom_player.controls = "controls";
      
    };

    attach_to_dom({parent_element}={}){
      console.log("worker rendered");
parent_element.appendChild(this.#dom_player);
    };

    play(track){
console.log("play", track);
      this.#dom_player.src = track.url;
      this.#dom_player.play();
      return true;
    };
    
    pause(track){
console.log("pause", track);
      this.#dom_player.pause();
      if(track){ this.#dom_player.src = track.url;};
      this.#dom_player.pause();
      return true;
    };

    set play_end_callback(cb){
     const t = this;
     if(t.#onplayend) this.#dom_player.removeEventListener(t.#onplayend);
     t.#onplayend = cb;
     if(cb) this.#dom_player.addEventListener("ended", t.#onplayend);
    };

    get play_end_callback(){
      const cb = t.#onplayend;//idk why i ve done this?
      return cb;
    };
    
  };// end Player_worker

  class Player_controller {

    player_worker ;
    _playlist;

    constructor(){
      this.player_worker = new Player_worker();
      this._playlist = new Playlist();

     this.attach_to_dom({parent_element: document});

      this.player_worker.play_end_callback = ()=>player_worker.play(this._playlist.next);
      
    };


    add(tr){
      if(this._playlist.empty()){
        this._playlist.add(tr);
 
this.player_worker.pause(this._playlist.current_track);
      }else{
      this._playlist.add(tr);
      };
    }

    attach_to_dom({parent_element}={}){
//console.log("controller rendered");
      this.player_worker.attach_to_dom( 
       { parent_element : document.querySelector(".player")}
      );
      this._playlist.attach_to_dom(
       { parent_element:document.querySelector(".tracks")}
      );
    };

  };//end Player_controller


  class Playlist {
    
    #repeat_one_mode;
    get repeat_one_mode() {return this.#repeat_one_mode;};

    #repeat_list=false;
    get repeat_list_mode() {return this.#repeat_list;};

    #current_track;
    get current_track(){return this.#current_track;};
    //set current_track(t_i){};//TODO!!!!!rearranging

    tracks;
    #play_order;//ref to other array
    #straight_order;//stack?
    #shuffled_order;//architectural problem with setting track, inverse array needed

    constructor(){ 
      this.#repeat_one_mode=false;
      this.#repeat_list

      this.tracks=[];

      this.#straight_order=new Straight_play_order();//stack?
      this.#shuffled_order=new Shuffled_play_order();
     
  this.#play_order=this.#straight_order;
    };

    add(track){
      let i = -1 + this.tracks.push(track);//returns length after push, which -1 is the index of new element
      this.#play_order.add(i);
    };

    get next(){
      if(!repeat_one_mode) this.#current_track=tracks[this.#play_order.next({repeat:this.repeat_list_mode})];
      return this.#current_track;
    };
    get prev(){
      if(!repeat_one_mode) this.#current_track=tracks[this.#play_order.prev({repeat:this.repeat_list_mode})];
      return this.#current_track;
    };

    attach_to_dom({parent_element}={}){
console.log("tracks rendered");
      for (let track of this.tracks) {
        track.attach_to_dom({parent_element});
      };
    };

    empty(){
      return 0 === this.tracks.length;
    };

  };//end Playlist
 
  class Play_order {
    _current_i;
    _container;
    constructor(){
      this._current_i = 0;
      this._container = [];
    };

    next(repeat=true){

      ++this._current_i;

      if(this._current_i>=this._container.length){
        if(repeat){
          this._current_i=0;
        }else{
          this._current_i=(this._container.length-1);
        };
      };
      return this._container[this._current_i];
    };

    prev(repeat=true){

      --this._current_i;

      if(this._current_i<0){
        if(repeat){
          this._current_i=this._container.length-1;
        }else{
          this._current_i=0;
        };
      };
      return this._container[this._current_i];
    }

    fill_from( order){
      throw new Error("not implemented");
    };

    add(track){
      throw new Error("not implemented");
    };
    
  };//end Play_order


  class Straight_play_order extends Play_order{
    constructor(){super();};
    fill_from(order){
      this._container=Array.from(order);
    };
    
    add(w){
      this._container.push(w);
    };
  };//end Straight_play_order

  class Shuffled_play_order extends Play_order{
    inversed_order;
    constructor(){super();};

    fill_from(order){
      const c=Array.from(order);

      for (let i = c.length-1;i >=0;--i){
        const random_index = Math.round(Math.random()*i);
        c[i]=c[random_index];
        inversed_order[random_index]=inversed_order[i];//experimental
      };
      this._container = c;
    };

    add(w){
      const max_i = this._container.length-1;
      const random_index = Math.round(Math.random()*max_i);
      this._container.splice(random_index,0,w);//bevare the complexity=O(n)
    };

  };//end Shuffled_play_order


  class Track{
    id;
    name;
    url;
    constructor(file){
    this.id="";
    this.name="";
    this.url="";


      this.name=file.name;
      this.url=URL.createObjectURL(file);
    }

    attach_to_dom({parent_element}={}){
console.log("track rendered",this.name);
      let li = document.createElement("li");
      li.innerText = this.name;
      parent_element.appendChild(li);
    };

    //render_string(){}

  };//end Track
 


  const player_brain = new Player_controller();

  const push_files_to_list = files => {
console.log("pishfi");
    for (let i = 0, l = files.length; i < l; ++i) {
      let file = files[i];
      player_brain.add(new Track(file));
    };
  player_brain.attach_to_dom();
  };

  let fileinput = document.querySelector("#fileinput");
  fileinput.addEventListener("change",e=>{
    push_files_to_list(fileinput.files);
  });

  window.addEventListener("dragover", e => e.preventDefault(), false); 
  window.addEventListener("drop", event => {
    event.preventDefault();
    push_files_to_list(event.dataTransfer.files);
  });


let [main,playlist,player] = [".main",".playlist",".player"].map(s=>document.querySelector(s).classList);

let visible = 0;

let [t1,t2]= [".player_tab_toggler",".playlist_tab_toggler"].map(s=>document.querySelector(s));

t1.addEventListener("click",()=>{
  if(visible!==1){

    visible=1;

    [main,playlist].map(e=>(e.remove("visible"),e)).map(e=>e.add("hidden"));
    player.remove("hidden");
    player.add("visible");

    t2.classList.remove("active");
    t1.classList.add("active");
    
  }else{
    visible=0;

    player.add("hidden");
    player.remove("visible");
    main.remove("hidden");
    main.add("visible");

    t1.classList.remove("active");
  };
});

t2.addEventListener("click",()=>{

if(visible!==2){

    visible=2;

    [main,player].map(e=>(e.remove("visible"),e)).map(e=>e.add("hidden"));
    playlist.remove("hidden");
    playlist.add("visible");

    t1.classList.remove("active");
    t2.classList.add("active");
  }else{
    visible=0;

    playlist.add("hidden");
    playlist.remove("visible");
    main.remove("hidden");
    main.add("visible");

    t2.classList.remove("active");
  };
});



console.log("endcript")



    </script>

</body>

</html>
